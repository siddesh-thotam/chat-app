{% load static %}
{% load dict_key %}
<!-- Updated Header Template -->
<header class="bg-gray-900/95 backdrop-blur-xl border-b border-gray-800/50 shadow-lg sticky top-0 z-50">
    <div class="max-w-7xl mx-auto px-3 sm:px-6 lg:px-8">
        <div class="flex justify-between items-center h-14 sm:h-16">
            <!-- Logo -->
            <div class="flex items-center gap-3">
                <a href="{% url 'chatroom' 'public-chat' %}" class="w-8 h-8 sm:w-10 sm:h-10 bg-gradient-to-br from-red-600 to-red-800 rounded-xl flex items-center justify-center shadow-lg">
                    <svg class="w-5 h-5 sm:w-6 sm:h-6 text-white" fill="currentColor" viewBox="0 0 20 20">
                        <path d="M18 10c0 3.866-3.582 7-8 7a8.841 8.841 0 01-4.083-.98L2 17l1.338-3.123C2.493 12.767 2 11.434 2 10c0-3.866 3.582-7 8-7s8 3.134 8 7zM7 9H5v2h2V9zm8 0h-2v2h2V9zM9 9h2v2H9V9z"/>
                    </svg>
                </a>
                
                <!-- Users online in server -->
                {% if request.user.is_authenticated %}
                <div class="flex items-center gap-2">
                    <div class="w-2 h-2 bg-green-500 rounded-full animate-pulse shadow-lg shadow-green-500/50"></div>
                    <span class="text-white text-sm sm:text-base font-medium">
                        <span id="online-users-count" class="text-green-400">--</span> users online in server
                    </span>
                </div>
                {% endif %}
            </div>

            <!-- Navigation -->
            <nav class="flex items-center gap-2">
                {% if request.user.is_authenticated %}
                <ul class="flex items-center gap-2">
                    <!-- Switch Group Dropdown -->
                    <li x-data="{ groupDropdownOpen: false }" class="relative">
                        <button @click="groupDropdownOpen = !groupDropdownOpen" @click.away="groupDropdownOpen = false" class="flex items-center gap-2 px-3 py-2 rounded-xl bg-gray-900 hover:bg-gray-800 text-gray-300 hover:text-white transition-all duration-300">
                            <svg class="w-5 h-5 text-gray-400" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M5.23 7.21a.75.75 0 011.06.02L10 10.94l3.71-3.71a.75.75 0 111.06 1.06l-4.24 4.24a.75.75 0 01-1.06 0L5.23 8.27a.75.75 0 01.02-1.06z" clip-rule="evenodd" />
                            </svg>
                            <span class="hidden sm:inline">Switch Group</span>
                        </button>
                        <div x-show="groupDropdownOpen" x-cloak class="absolute left-0 mt-2 w-48 bg-gray-900 border border-gray-700 rounded-xl shadow-lg z-50 py-2">
                            <ul class="flex flex-col gap-1">
                                {% for group in user_groupchats %}
                                    <li>
                                        <a href="{% url 'chatroom' group.group_name %}" class="block px-4 py-2 rounded-lg text-gray-300 hover:bg-red-600/80 hover:text-white transition-all duration-200 font-medium whitespace-nowrap">
                                            {{ group.display_name }}
                                        </a>
                                    </li>
                                {% empty %}
                                    <li class="px-4 py-2 text-gray-500">No groups found.</li>
                                {% endfor %}
                            </ul>
                        </div>
                    </li>
                    <!-- User Profile Dropdown -->
                    <li x-data="{ dropdownOpen: false }" class="relative">
                        <a @click="dropdownOpen = !dropdownOpen" 
                           @click.away="dropdownOpen = false" 
                           class="cursor-pointer select-none flex items-center gap-3 px-4 py-2 rounded-xl hover:bg-gray-700/50 transition-all duration-300 group">
                            <div class="relative">
                                <img class="w-10 h-10 rounded-full object-cover border-2 border-gray-600 group-hover:border-red-500 transition-colors duration-300 shadow-lg" 
                                     src="{{ request.user.profile.avatar }}" 
                                     alt="Avatar" />
                                <div class="absolute -bottom-1 -right-1 w-3 h-3 bg-green-500 rounded-full border-2 border-gray-900 shadow-lg shadow-green-500/50"></div>
                            </div>
                            <div class="hidden md:block text-left">
                                <div class="font-medium text-white group-hover:text-red-400 transition-colors duration-300">
                                    {{ request.user.profile.name }}
                                </div>
                                <div class="text-xs text-gray-400">@{{ request.user.username }}</div>
                            </div>
                            <svg class="w-4 h-4 transition-transform duration-300 text-gray-400 group-hover:text-white" 
                                 :class="dropdownOpen ? 'rotate-180' : ''" 
                                 fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                            </svg>
                        </a>
                        
                        <div x-show="dropdownOpen" 
                             x-cloak 
                             class="absolute right-0 mt-2 bg-gray-800/95 backdrop-blur-xl border border-gray-700/50 shadow-2xl rounded-2xl w-56 p-3 z-20"
                             x-transition:enter="duration-300 ease-out"
                             x-transition:enter-start="opacity-0 -translate-y-5 scale-90"
                             x-transition:enter-end="opacity-100 translate-y-0 scale-100"
                             x-transition:leave="duration-200 ease-in"
                             x-transition:leave-start="opacity-100 translate-y-0 scale-100"
                             x-transition:leave-end="opacity-0 -translate-y-5 scale-90">
                            
                            <div class="text-xs font-semibold text-gray-400 uppercase tracking-wider mb-3 px-2">Account</div>
                            
                            <ul class="space-y-1">
                                <li>
                                    <a href="{% url 'profile' %}" 
                                       class="flex items-center gap-3 px-3 py-2 rounded-xl hover:bg-gray-700/50 transition-all duration-300 group">
                                        <svg class="w-5 h-5 text-gray-400 group-hover:text-blue-400 transition-colors duration-300" fill="currentColor" viewBox="0 0 20 20">
                                            <path fill-rule="evenodd" d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z" clip-rule="evenodd"/>
                                        </svg>
                                        <span class="text-gray-300 group-hover:text-white transition-colors duration-300">My Profile</span>
                                    </a>
                                </li>
                                <li>
                                    <a href="{% url 'profile-edit' %}" 
                                       class="flex items-center gap-3 px-3 py-2 rounded-xl hover:bg-gray-700/50 transition-all duration-300 group">
                                        <svg class="w-5 h-5 text-gray-400 group-hover:text-green-400 transition-colors duration-300" fill="currentColor" viewBox="0 0 20 20">
                                            <path d="M13.586 3.586a2 2 0 112.828 2.828l-.793.793-2.828-2.828.793-.793zM11.379 5.793L3 14.172V17h2.828l8.38-8.379-2.83-2.828z"/>
                                        </svg>
                                        <span class="text-gray-300 group-hover:text-white transition-colors duration-300">Edit Profile</span>
                                    </a>
                                </li>
                                <li>
                                    <a href="{% url 'new-groupchat' %}" 
                                       class="flex items-center gap-3 px-3 py-2 rounded-xl hover:bg-gray-700/50 transition-all duration-300 group">
                                        <svg class="w-5 h-5 text-gray-400 group-hover:text-purple-400 transition-colors duration-300" fill="currentColor" viewBox="0 0 20 20">
                                            <path d="M8 9a3 3 0 100-6 3 3 0 000 6zM8 11a6 6 0 016 6H2a6 6 0 016-6zM16 7a1 1 0 10-2 0v1h-1a1 1 0 100 2h1v1a1 1 0 102 0v-1h1a1 1 0 100-2h-1V7z"/>
                                        </svg>
                                        <span class="text-gray-300 group-hover:text-white transition-colors duration-300">Create Chat</span>
                                    </a>
                                </li>
                                <li>
                                    <a href="{% url 'profile-settings' %}" 
                                       class="flex items-center gap-3 px-3 py-2 rounded-xl hover:bg-gray-700/50 transition-all duration-300 group">
                                        <svg class="w-5 h-5 text-gray-400 group-hover:text-yellow-400 transition-colors duration-300" fill="currentColor" viewBox="0 0 20 20">
                                            <path fill-rule="evenodd" d="M11.49 3.17c-.38-1.56-2.6-1.56-2.98 0a1.532 1.532 0 01-2.286.948c-1.372-.836-2.942.734-2.106 2.106.54.886.061 2.042-.947 2.287-1.561.379-1.561 2.6 0 2.978a1.532 1.532 0 01.947 2.287c-.836 1.372.734 2.942 2.106 2.106a1.532 1.532 0 012.287.947c.379 1.561 2.6 1.561 2.978 0a1.533 1.533 0 012.287-.947c1.372.836 2.942-.734 2.106-2.106a1.533 1.533 0 01.947-2.287c1.561-.379 1.561-2.6 0-2.978a1.532 1.532 0 01-.947-2.287c.836-1.372-.734-2.942-2.106-2.106a1.532 1.532 0 01-2.287-.947zM10 13a3 3 0 100-6 3 3 0 000 6z" clip-rule="evenodd"/>
                                        </svg>
                                        <span class="text-gray-300 group-hover:text-white transition-colors duration-300">Settings</span>
                                    </a>
                                </li>
                            </ul>
                            
                            <div class="mt-3 pt-3 border-t border-gray-700/50">
                                <a href="{% url 'account_logout' %}" 
                                   class="flex items-center gap-3 px-3 py-2 rounded-xl hover:bg-red-600/20 transition-all duration-300 group">
                                    <svg class="w-5 h-5 text-gray-400 group-hover:text-red-400 transition-colors duration-300" fill="currentColor" viewBox="0 0 20 20">
                                        <path fill-rule="evenodd" d="M3 3a1 1 0 00-1 1v12a1 1 0 102 0V4a1 1 0 00-1-1zm10.293 9.293a1 1 0 001.414 1.414l3-3a1 1 0 000-1.414l-3-3a1 1 0 10-1.414 1.414L14.586 9H7a1 1 0 100 2h7.586l-1.293 1.293z" clip-rule="evenodd"/>
                                    </svg>
                                    <span class="text-gray-300 group-hover:text-red-400 transition-colors duration-300">Log Out</span>
                                </a>
                            </div>
                        </div>
                    </li>
                </ul>
                {% else %}
                <a href="{% url 'account_login' %}" class="px-4 py-2 bg-red-600 hover:bg-red-700 text-white rounded-xl transition-colors duration-300">
                    Sign In
                </a>
                {% endif %}
            </nav>
        </div>
    </div>
</header>

<!-- Online users count update script -->
{% if request.user.is_authenticated %}
<script>
    // WebSocket connection for online users count
    const onlineStatusSocket = new WebSocket(
        (window.location.protocol === 'https:' ? 'wss:' : 'ws:') + '//' + window.location.host + '/ws/online-status/'
    );

    onlineStatusSocket.onmessage = function(e) {
        try {
            const data = JSON.parse(e.data);
            if (data.online_count !== undefined) {
                const countElement = document.getElementById('online-users-count');
                if (countElement) {
                    countElement.textContent = data.online_count;
                }
            }
        } catch (error) {
            // Handle HTML response (fallback)
            const countElement = document.getElementById('online-users-count');
            if (countElement && e.data.includes('online in server')) {
                const match = e.data.match(/(\d+)\s+online in server/);
                if (match) {
                    countElement.textContent = match[1];
                }
            }
        }
    };

    onlineStatusSocket.onclose = function(e) {
        console.log('Online status socket closed');
        // Attempt to reconnect after 3 seconds
        setTimeout(function() {
            if (window.location.protocol.startsWith('http')) {
                location.reload();
            }
        }, 3000);
    };
    
    onlineStatusSocket.onerror = function(e) {
        console.log('WebSocket error:', e);
    };
</script>
{% endif %}